name: CI/CD for Calendar Service

on:
  push:
    branches: [ "main" ]
    paths:
      - "calendar/**"
      - ".github/workflows/calendar-ci.yml"
      - "nomad/calendar.hcl"
      - "docker/Dockerfile.stage"
  pull_request:
    branches: [ "main" ]
    paths:
      - "calendar/**"
      - ".github/workflows/calendar-ci.yml"
      - "nomad/calendar.hcl"

env:
  IMAGE_TAG: ${{ github.ref_name }}-${{ github.sha }}
  DOCKER_IMAGE: friendy21/calendar-service
  SERVICE_NAME: calendar-service
  SERVICE_PORT: 5002

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./calendar
        file: ./docker/Dockerfile.stage
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VERSION=${{ env.IMAGE_TAG }}

    - name: Run security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_IMAGE }}:latest
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Nomad
      uses: hashicorp/setup-nomad@main
      with:
        nomad_version: 'latest'

    - name: Verify Nomad installation
      run: |
        echo "‚úÖ Nomad version:"
        nomad version
        echo "‚úÖ Nomad path:"
        which nomad

    - name: Debug repository structure
      run: |
        echo "üîç Debugging repository structure..."
        echo "üìÅ Current directory: $(pwd)"
        echo "üìÅ Directory contents:"
        ls -la
        echo ""
        echo "üîç Looking for Nomad HCL files:"
        find . -name "*.hcl" -type f || echo "No .hcl files found"
        echo ""
        echo "üìÅ Checking nomad directory:"
        if [ -d nomad ]; then
          echo "‚úÖ nomad directory exists"
          ls -la nomad/
        else
          echo "‚ùå nomad directory not found"
        fi

    - name: Validate and Deploy to Nomad
      env:
        NOMAD_ADDR: ${{ secrets.NOMAD_ADDR }}
        NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}
      run: |
        set -e
        
        echo "üîç Validating environment..."
        
        # Check required environment variables
        if [ -z "$NOMAD_ADDR" ]; then
          echo "‚ùå NOMAD_ADDR is not set"
          exit 1
        fi
        
        if [ -z "$NOMAD_TOKEN" ]; then
          echo "‚ùå NOMAD_TOKEN is not set"
          exit 1
        fi
        
        echo "‚úÖ Environment variables validated"
        echo "üéØ Nomad Address: $NOMAD_ADDR"
        echo "üîß Image: ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}"
        
        # Find the HCL file
        HCL_FILE="nomad/calendar.hcl"
        
        if [ ! -f "$HCL_FILE" ]; then
          echo "‚ùå HCL file not found at expected location: $HCL_FILE"
          echo "üîç Searching for calendar.hcl in entire repository..."
          
          FOUND_FILE=$(find . -name "calendar.hcl" -type f | head -1)
          if [ -n "$FOUND_FILE" ]; then
            echo "‚úÖ Found HCL file at: $FOUND_FILE"
            HCL_FILE="$FOUND_FILE"
          else
            echo "‚ùå calendar.hcl not found anywhere in repository"
            echo "üìÅ Available files:"
            find . -name "*.hcl" -type f || echo "No .hcl files found"
            exit 1
          fi
        else
          echo "‚úÖ Found HCL file at expected location: $HCL_FILE"
        fi
        
        # Create backup with timestamp
        BACKUP_FILE="${HCL_FILE}.backup.$(date +%s)"
        cp "$HCL_FILE" "$BACKUP_FILE"
        echo "üíæ Created backup: $BACKUP_FILE"
        
        # Show original content for debugging
        echo "üìÑ Original HCL file content (first 20 lines):"
        echo "----------------------------------------"
        head -20 "$HCL_FILE"
        echo "----------------------------------------"
        
        # Replace placeholders with better error handling
        echo "üîÑ Replacing placeholders..."
        if ! sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ env.IMAGE_TAG }}|g" "$HCL_FILE"; then
          echo "‚ùå Failed to replace IMAGE_TAG_PLACEHOLDER"
          exit 1
        fi
        
        if ! sed -i "s|DOCKER_IMAGE_PLACEHOLDER|${{ env.DOCKER_IMAGE }}|g" "$HCL_FILE"; then
          echo "‚ùå Failed to replace DOCKER_IMAGE_PLACEHOLDER"
          exit 1
        fi
        
        # Verify replacements more thoroughly
        echo "üîç Checking for remaining placeholders..."
        REMAINING_PLACEHOLDERS=$(grep -c "PLACEHOLDER" "$HCL_FILE" || echo "0")
        if [ "$REMAINING_PLACEHOLDERS" -gt 0 ]; then
          echo "‚ùå Found $REMAINING_PLACEHOLDERS remaining placeholders:"
          grep "PLACEHOLDER" "$HCL_FILE" || true
          echo ""
          echo "üìÑ Current file content:"
          echo "----------------------------------------"
          cat "$HCL_FILE"
          echo "----------------------------------------"
          echo "üîÑ Restoring from backup..."
          cp "$BACKUP_FILE" "$HCL_FILE"
          exit 1
        fi
        
        echo "‚úÖ Placeholders replaced successfully"
        
        # Show final content for verification
        echo "üìÑ Final HCL file content (image line):"
        echo "----------------------------------------"
        grep -n "image.*=" "$HCL_FILE" || echo "No image line found"
        echo "----------------------------------------"
        
        # Test Nomad connectivity with retry logic
        echo "üîó Testing Nomad connectivity..."
        MAX_CONN_ATTEMPTS=5
        CONN_ATTEMPT=0
        
        while [ $CONN_ATTEMPT -lt $MAX_CONN_ATTEMPTS ]; do
          if nomad node status >/dev/null 2>&1; then
            echo "‚úÖ Nomad connectivity verified"
            break
          fi
          
          CONN_ATTEMPT=$((CONN_ATTEMPT + 1))
          if [ $CONN_ATTEMPT -lt $MAX_CONN_ATTEMPTS ]; then
            echo "‚è≥ Connection attempt $CONN_ATTEMPT/$MAX_CONN_ATTEMPTS failed, retrying in 10s..."
            sleep 10
          else
            echo "‚ùå Cannot connect to Nomad at $NOMAD_ADDR after $MAX_CONN_ATTEMPTS attempts"
            echo "üîç Nomad server info:"
            curl -s "$NOMAD_ADDR/v1/status/leader" || echo "Failed to get leader info"
            exit 1
          fi
        done
        
        # Validate job
        echo "üîç Validating Nomad job..."
        if ! nomad job validate "$HCL_FILE"; then
          echo "‚ùå Job validation failed"
          echo "üìÑ Job file contents:"
          cat "$HCL_FILE"
          exit 1
        fi
        echo "‚úÖ Job validation passed"
        
        # Plan the job (dry run)
        echo "üìã Planning job deployment..."
        if ! nomad job plan "$HCL_FILE"; then
          echo "‚ö†Ô∏è Job planning failed, but continuing with deployment..."
        else
          echo "‚úÖ Job planning completed"
        fi
        
        # Run the job
        echo "üöÄ Deploying calendar-service..."
        if ! nomad job run "$HCL_FILE"; then
          echo "‚ùå Job submission failed"
          nomad job status calendar-service || true
          exit 1
        fi
        echo "‚úÖ Job submitted successfully"
        
        # Enhanced deployment monitoring
        echo "‚è≥ Waiting for deployment to complete..."
        MAX_ATTEMPTS=120  # Increased timeout to 20 minutes
        ATTEMPT=0
        LAST_STATUS=""
        STABLE_COUNT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          # Get job status with better error handling
          STATUS=$(nomad job status calendar-service 2>/dev/null | grep "^Status" | awk '{print $3}' 2>/dev/null || echo "unknown")
          
          # Only log status changes to reduce noise
          if [ "$STATUS" != "$LAST_STATUS" ]; then
            echo "üìä Status update ($((ATTEMPT + 1))/$MAX_ATTEMPTS): $STATUS"
            LAST_STATUS="$STATUS"
            STABLE_COUNT=0
          fi
          
          case "$STATUS" in
            "running")
              STABLE_COUNT=$((STABLE_COUNT + 1))
              
              # Wait for stable running state
              if [ $STABLE_COUNT -ge 3 ]; then
                echo "‚úÖ Calendar service is running stably!"
                
                # Get deployment summary
                echo "üìä Deployment summary:"
                nomad job status calendar-service | head -20
                
                # Enhanced health check with proper networking
                echo "üè• Testing service health..."
                
                # Get allocation info first
                ALLOC_ID=$(nomad job allocs calendar-service -json 2>/dev/null | jq -r '.[0].ID' 2>/dev/null || echo "")
                
                if [ -n "$ALLOC_ID" ] && [ "$ALLOC_ID" != "null" ]; then
                  # Get the actual IP address of the allocation
                  ALLOC_IP=$(nomad alloc status "$ALLOC_ID" 2>/dev/null | grep -E "Host Network.*:" | awk -F':' '{print $2}' | tr -d ' ' || echo "localhost")
                  
                  for health_attempt in {1..10}; do
                    echo "üîÑ Health check attempt $health_attempt/10..."
                    
                    # Try multiple health check methods
                    for health_url in "http://${ALLOC_IP}:${{ env.SERVICE_PORT }}/health" "http://localhost:${{ env.SERVICE_PORT }}/health"; do
                      if timeout 10 curl -f -s "$health_url" >/dev/null 2>&1; then
                        echo "‚úÖ Health check passed via $health_url"
                        
                        # Get detailed health info
                        HEALTH_INFO=$(timeout 5 curl -s "$health_url" 2>/dev/null | jq . 2>/dev/null || echo "Health endpoint responded")
                        echo "üìä Service health: $HEALTH_INFO"
                        
                        exit 0
                      fi
                    done
                    
                    if [ $health_attempt -lt 10 ]; then
                      sleep 15
                    fi
                  done
                  
                  echo "‚ö†Ô∏è Health check failed, but service is running"
                  echo "üîç This might be normal if the service is still initializing"
                else
                  echo "‚ö†Ô∏è Could not get allocation ID for health check"
                fi
                
                exit 0
              fi
              ;;
            "dead"|"failed")
              echo "‚ùå Deployment failed with status: $STATUS"
              echo "üìä Job status details:"
              nomad job status calendar-service || true
              echo ""
              echo "üìã Recent allocations:"
              nomad job allocs calendar-service || true
              echo ""
              echo "üìù Recent logs:"
              FAILED_ALLOC_ID=$(nomad job allocs calendar-service -json 2>/dev/null | jq -r '.[0].ID' 2>/dev/null || echo "")
              if [ -n "$FAILED_ALLOC_ID" ] && [ "$FAILED_ALLOC_ID" != "null" ]; then
                nomad alloc logs -n 50 "$FAILED_ALLOC_ID" 2>/dev/null || echo "No logs available"
              fi
              exit 1
              ;;
            "pending")
              # Show detailed info every 20 attempts to reduce noise
              if [ $((ATTEMPT % 20)) -eq 0 ] && [ $ATTEMPT -gt 0 ]; then
                echo "üìä Still pending after $((ATTEMPT * 10)) seconds..."
                nomad job status calendar-service | head -15 || true
              fi
              ;;
          esac
          
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
        done
        
        # Timeout reached
        echo "‚ùå Deployment timed out after $((MAX_ATTEMPTS * 10)) seconds"
        echo "üìä Final job status:"
        nomad job status calendar-service || true
        echo ""
        echo "üìã Allocations:"
        nomad job allocs calendar-service || true
        exit 1
